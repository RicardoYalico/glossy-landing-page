!(function (window, document) {
  'use strict';

  // --- Configuration ---
  const SCRIPT_ID_MARKER = 'trakkr-client.min.js';
  const DEFAULT_ENDPOINT_URL = 'https://track-visit-830752870576.us-east1.run.app/trackBotVisit';

  // --- Helper Functions ---
  function log(...args) { console.log('Trakkr.ai:', ...args); }
  function error(...args) { console.error('Trakkr.ai Error:', ...args); }

  // --- Script Identification ---
  let currentScriptTag = document.currentScript;
  if (!currentScriptTag) {
    const scripts = document.getElementsByTagName('script');
    for (let i = scripts.length - 1; i >= 0; i--) {
      if (scripts[i].src && scripts[i].src.includes(SCRIPT_ID_MARKER)) {
        currentScriptTag = scripts[i];
        break;
      }
    }
  }

  if (!currentScriptTag) {
    error('Critical - Could not identify the script tag. Tracking will not proceed.');
    return;
  }

  // --- Get Configuration from Script Tag ---
  const trackingId = currentScriptTag.getAttribute('data-tracking-id');
  const endpointUrl = currentScriptTag.getAttribute('data-endpoint-url') || window.TRAKKR_ENDPOINT_URL || DEFAULT_ENDPOINT_URL;

  if (!trackingId) {
    error("'data-tracking-id' attribute is missing. Tracking disabled.");
    return;
  }

  log('Initialized. Tracking ID:', trackingId);

  // --- AI/LLM Bot Detection Patterns ---
  const AI_BOT_PATTERNS = [
    { name: 'ChatGPT-User', pattern: /ChatGPT-User/i, type: 'LLM Interaction' },
    { name: 'Perplexity-User', pattern: /Perplexity-User/i, type: 'LLM Interaction' },
    { name: 'Claude-User', pattern: /Claude-User/i, type: 'LLM Interaction' },
    { name: 'Meta-ExternalFetcher', pattern: /Meta-ExternalFetcher|facebookexternalhit/i, type: 'LLM Interaction (Meta AI)' },
    { name: 'GPTBot', pattern: /GPTBot/i, type: 'LLM Training Data (OpenAI)' },
    { name: 'ClaudeBot', pattern: /ClaudeBot/i, type: 'LLM Training Data (Anthropic)' },
    { name: 'Google-Extended', pattern: /Google-Extended/i, type: 'LLM Training Data (Google)' },
    { name: 'PerplexityBot', pattern: /PerplexityBot/i, type: 'AI Search Crawler (Perplexity)' },
    { name: 'YouBot', pattern: /YouBot/i, type: 'AI Search Crawler (You.com)' },
    { name: 'Amazonbot', pattern: /Amazonbot/i, type: 'LLM Training Data (Amazon)' },
    { name: 'anthropic-ai', pattern: /anthropic-ai/i, type: 'AI Related (Anthropic)' },
    { name: 'cohere-ai', pattern: /cohere-ai/i, type: 'AI Related (Cohere)' },
    { name: 'NeevaBot', pattern: /NeevaBot/i, type: 'AI Search Crawler (Neeva - Acquired)' },
    { name: 'Bytespider', pattern: /Bytespider/i, type: 'LLM Training Data (ByteDance)' },
    { name: 'CCBot', pattern: /CCBot/i, type: 'LLM Training Data (Common Crawl)' },
    { name: 'Diffbot', pattern: /Diffbot/i, type: 'AI Content Extraction' },
    { name: 'Omgili', pattern: /omgili|omgilibot/i, type: 'Content Aggregator (Potential AI Data Source)' },
    { name: 'MistralAI-User', pattern: /MistralAI-User/i, type: 'LLM Interaction (Mistral AI)' },
    { name: 'Claude-Web', pattern: /Claude-Web/i, type: 'AI Related (Anthropic)' },
    { name: 'OAI-SearchBot', pattern: /OAI-SearchBot/i, type: 'AI Search Crawler (OpenAI)' },
    { name: 'Applebot-Extended', pattern: /Applebot-Extended/i, type: 'LLM Training Data (Apple)' },
  ];

  // --- Main Tracking Function ---
  function trackVisit() {
    const userAgent = window.navigator.userAgent;

    function identifyBot(ua) {
      if (!ua) return null;
      for (const bot of AI_BOT_PATTERNS) {
        if (bot.pattern.test(ua)) return { type: bot.type, name: bot.name };
      }
      return null;
    }

    const botInfo = identifyBot(userAgent);

    if (botInfo) {
      log('AI Bot detected:', botInfo.name);
      try {
        // --- NEW: GATHER ALL CLIENT-SIDE CONTEXT ---
        const payload = {
          // Core tracking info
          tid: trackingId,
          ua: userAgent,
          ts: new Date().toISOString(),
          bot_type: botInfo.type,
          bot_name: botInfo.name,
          // Page context
          url: window.location.href,
          ref: document.referrer || null,
          // Device & Browser context (with short keys)
          scr: `${window.screen.width}x${window.screen.height}`,
          vp: `${window.innerWidth}x${window.innerHeight}`,
          dpr: window.devicePixelRatio || null,
          tz: Intl.DateTimeFormat().resolvedOptions().timeZone,
          touch: !!('ontouchstart' in window || navigator.maxTouchPoints > 0),
        };

        const payloadJson = JSON.stringify(payload);
        const blob = new Blob([payloadJson], { type: 'application/json' });

        if (navigator.sendBeacon) {
          navigator.sendBeacon(endpointUrl, blob);
        } else {
          fetch(endpointUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: payloadJson,
            mode: 'cors',
            keepalive: true,
          }).catch(err => error('Fetch fallback failed:', err));
        }
      } catch (err) {
        error('Error preparing or sending tracking data:', err);
      }
    }
  }

  // --- Initialize ---
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', trackVisit);
  } else {
    trackVisit();
  }
})(window, document);